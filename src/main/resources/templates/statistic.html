<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <title>Statistic</title>
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="/webjars/materializecss/1.0.0/css/materialize.min.css"
          media="screen,projection"/>

    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <!--JavaScript at end of body for optimized loading-->
    <script type="text/javascript" src="/webjars/materializecss/1.0.0/js/materialize.min.js"></script>
    <script src="/webjars/chartjs/2.7.3/Chart.js"></script>
</head>
<body>
<header>
    <nav>
        <div class="nav-wrapper">
            <div class="col s12">
                <a th:href="@{/smartphone}" class="breadcrumb">Smartphones</a>
                <a class="breadcrumb" th:text="|${statistic.brand} ${statistic.model}|"></a>
            </div>
        </div>
    </nav>
</header>
<main>
    <div class="row">
        <div>
            <h3 class="center-align" th:text="|${statistic.brand} ${statistic.model}| + ' statistics'"></h3>
        </div>
        <div class="col s6">
            <form action="#"
                  th:action="@{/smartphone(isRatingEnabled=${param.isRatingEnabled}, isSeasonEnabled=${param.isSeasonEnabled})}"
                  th:object="${statistic}" th:method="put">
                <input th:type="hidden" th:field="${statistic.id}"/>

                <div class="col s6">
                    <div class="row">
                        <!--<p th:text="${param.isRatingEnabled != null} ? ${param.isRatingEnabled} : true">TEST</p>-->
                        <p class="col s4 offset-s4">
                            <label>
                                <input type="checkbox" class="filled-in"
                                       th:id="rating_check"
                                       th:checked="${#strings.equals(param.isRatingEnabled, 'true')} ? 'checked'"
                                       th:onclick="'javascript:reloadPage();'"
                                />
                                <span>Rating</span>
                            </label>
                        </p>
                    </div>
                    <div class="row">
                        <div class="col s4" th:each="entry : ${statistic.ratings}">

                            <!--This is an inline input field:-->
                            <div class="input-field inline">
                                <label th:for="${entry.key}" th:text="${entry.key}">example</label>
                                <input th:id="${entry.key}" th:field="*{ratings[__${entry.key}__]}"
                                       th:value="${entry.value}" type="number" step="0.01" class="validate"
                                       required="required" min="0.0" max="5.0"/>
                                <span class="helper-text" data-error="wrong" data-success="right"></span>
                            </div>

                        </div>
                    </div>
                </div>
                <div class="col s6">
                    <div class="row">
                        <p class="col s4 offset-s4">
                            <label>
                                <input type="checkbox" class="filled-in"
                                       th:id="season_check"
                                       th:checked="${#strings.equals(param.isSeasonEnabled, 'true')} ? 'checked'"
                                       th:onclick="'javascript:reloadPage();'"
                                />
                                <span>Season</span>
                            </label>
                        </p>
                    </div>
                    <div class="row">
                        <div class="col s4" th:each="entry : ${statistic.coefficients}">

                            <!--This is an inline input field:-->
                            <div class="input-field inline">
                                <label th:for="${entry.key}" th:text="${entry.key}">example</label>
                                <input th:id="${entry.key}" th:field="*{coefficients[__${entry.key}__]}"
                                       th:value="${entry.value}" type="number" step="0.01" class="validate"
                                       required="required"/>
                                <span class="helper-text" data-error="wrong" data-success="right"></span>
                            </div>

                        </div>
                    </div>
                </div>

                <button class="fixed-action-btn btn-floating btn-large cyan" type="submit" name="action">
                    <i class="material-icons">save</i>
                </button>

            </form>
        </div>
        <div class="col s6">
            <canvas id="salesChart"></canvas>
        </div>
    </div>

    <div class="row">
        <div class="col s6">
            <h3>Lost profit</h3>
            <canvas id="couldSoldChart"></canvas>
        </div>
        <div class="col s6">
            <h3>Redundant purchase</h3>
            <canvas id="redundantPurchaseChart"></canvas>
        </div>
    </div>

    <div class="container row">
        <table>
            <thead>
            <tr>
                <th>Year Quarter</th>
                <th>Moving average</th>
                <th>Disabled</th>
                <th>Rating Only</th>
                <th>Seasons Only</th>
                <th>Rating & Seasons</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="entry:${statistic.methodEvaluation.get('Number')}">
                <td th:text="${entry.key}"></td>
                <td th:text="'<' + ${entry.value.get('Moving average').first} + '_' + ${entry.value.get('Moving average').second} + '>'"></td>
                <td th:text="'<' + ${entry.value.get('Disabled').first} + '_' + ${entry.value.get('Disabled').second} + '>'"></td>
                <td th:text="'<' + ${entry.value.get('RatingOnly').first} + '_' + ${entry.value.get('RatingOnly').second} + '>'"></td>
                <td th:text="'<' + ${entry.value.get('SeasonsOnly').first} + '_' + ${entry.value.get('SeasonsOnly').second} + '>'"></td>
                <td th:text="'<' + ${entry.value.get('Rating And Seasons').first} + '_' + ${entry.value.get('Rating And Seasons').second} + '>'"></td>
            </tr>
            </tbody>
        </table>
    </div>


</main>
<!--<footer>-->
<!--<div th:replace="fragments/footer :: footer"/>-->
<!--</footer>-->

<!--@formatter:off-->

<script th:inline="javascript">
    /*<![CDATA[*/

    function reloadPage() {
        var id = [[${statistic.id.toString()}]];
        var isRatingEnabled = document.getElementById('rating_check').checked;
        var isSeasonEnabled = document.getElementById('season_check').checked;
        var href = 'http://localhost:8080/smartphone/sales?id=' + id + '&isRatingEnabled=' + isRatingEnabled + '&isSeasonEnabled=' + isSeasonEnabled;
        console.log(href);
        window.location.href = href;
    }

    var salesChart = null;
    document.addEventListener('DOMContentLoaded', function () {
        var elem = document.querySelector('.collapsible.expandable');
        var instance = M.Collapsible.init(elem, {
            accordion: false
        });

        var sales = /*[[${statistic.sales}]]*/;

        var yearMonths = Object.keys(sales);
        var quantities = Object.values(sales);

        let expectedQuantities = quantities.map(quantity => quantity.expectedQuantity
    )
        ;
        let customCoefficientDisabledQuantities = quantities.map(quantity => quantity.customCoefficientDisabledQuantity
    )
        ;
        let customCoefficientRatingEnabledQuantities = quantities.map(quantity => quantity.customCoefficientRatingEnabledQuantity
    )
        ;
        let customCoefficientSeasonEnabledOnlyQuantities = quantities.map(quantity => quantity.customCoefficientSeasonEnabledOnlyQuantity
    )
        ;
        let customCoefficientEnabledQuantities = quantities.map(quantity => quantity.customCoefficientEnabledQuantity
    )
        ;
        let movingAverageQuantities = quantities.map(quantity => quantity.movingAverageQuantity
    )
        ;

        var ctx = document.getElementById("salesChart").getContext('2d');

        var expectedDataset = {
            label: 'Expected statistic',
            data: expectedQuantities,
            borderColor: 'green',
            backgroundColor: 'transparent',
            borderWidth: 3
        };

        var movingAverageDataset = {
            label: 'Moving average statistic',
            data: movingAverageQuantities,
            borderColor: 'black',
            backgroundColor: 'transparent',
            borderWidth: 1
        };

        var customCoefficientDisabledDataset = {
            label: 'Disabled',
            data: customCoefficientDisabledQuantities,
            borderColor: 'red',
            backgroundColor: 'transparent',
            borderWidth: 1
        };

        var customCoefficientRatingEnabledDataset = {
            label: 'Rating only',
            data: customCoefficientRatingEnabledQuantities,
            borderColor: 'purple',
            backgroundColor: 'transparent',
            borderWidth: 1
        };

        var customCoefficientSeasonEnabledDataset = {
            label: 'Seasons only',
            data: customCoefficientSeasonEnabledOnlyQuantities,
            borderColor: 'orange',
            backgroundColor: 'transparent',
            borderWidth: 1
        };

        var customCoefficientEnabledQuantityDataset = {
            label: 'Rating & seasons',
            data: customCoefficientEnabledQuantities,
            borderColor: 'blue',
            backgroundColor: 'transparent',
            borderWidth: 1
        };

        var options = {
            // scales: {
            //     yAxes: [{
            //         ticks: {
            //             // min: 0,
            //             // max: 500
            //         }
            //     }]
            // }
        };
        if (salesChart == null) {
            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: yearMonths,
                    datasets: [
                        expectedDataset,
                        movingAverageDataset,
                        customCoefficientDisabledDataset,
                        customCoefficientRatingEnabledDataset,
                        customCoefficientSeasonEnabledDataset,
                        customCoefficientEnabledQuantityDataset
                    ]
                },
                options: options
            });
        } else {
            salesChart.data.labels = yearMonths;
            salesChart.data.datasets = [
                expectedDataset,
                movingAverageDataset,
                customCoefficientDisabledDataset,
                customCoefficientRatingEnabledDataset,
                customCoefficientSeasonEnabledDataset,
                customCoefficientEnabledQuantityDataset
            ];
            salesChart.update();
        }
    });

    var couldSoldChart = null;
    var redundantPurchaseChart = null;

    document.addEventListener('DOMContentLoaded', function () {
        var elem = document.querySelector('.collapsible.expandable');
        var instance = M.Collapsible.init(elem, {
            accordion: false
        });

        var sales = /*[[${statistic.methodEvaluation}]]*/;

        var moneyDataMap = sales["Money"];

        var yearMonths = Object.keys(moneyDataMap);
        var moneyData = Object.values(moneyDataMap);

        let movingAverageDataCould = moneyData.map(moneyDataPair => {
            var test = moneyDataPair ['Moving average']
            return  test.first
        });

        let disabledDataCould = moneyData.map(moneyDataPair => {
            var test = moneyDataPair ['Disabled']
            console.log(test)
            return  test.first
        });
        let ratingDataCould = moneyData.map(moneyDataPair => {
            var test = moneyDataPair ['RatingOnly']
            console.log(test)
            return  test.first
        });
        let seasonsDataCould = moneyData.map(moneyDataPair => {
            var test = moneyDataPair ['SeasonsOnly']
            console.log(test)
            return  test.first
        });
        let ratingAndSeasonsDataCould = moneyData.map(moneyDataPair => {
            var test = moneyDataPair ['Rating And Seasons']
            console.log(test)
            return  test.first
        });

        var couldCtx = document.getElementById("couldSoldChart").getContext('2d');
        var couldData = {
            labels: yearMonths,
            datasets: [
                {
                    label: "Moving average",
                    backgroundColor: "black",
                    data: movingAverageDataCould
                },
                {
                    label: "Disabled",
                    backgroundColor: "red",
                    data: disabledDataCould
                },
                {
                    label: "Rating only",
                    backgroundColor: "purple",
                    data: ratingDataCould
                },
                {
                    label: "Seasons only",
                    backgroundColor: "orange",
                    data: seasonsDataCould
                },
                {
                    label: "Rating & seasons",
                    backgroundColor: "blue",
                    data: ratingAndSeasonsDataCould
                }
            ]
        };
        if (couldSoldChart == null) {
            couldSoldChart = new Chart(couldCtx, {
                type: 'bar',
                data: couldData,
                options: {
                    barValueSpacing: 20,
                    scales: {
                        yAxes: [{
                            ticks: {
                                min: 0,
                            }
                        }]
                    }
                }
            });
        }
        else {
            couldSoldChart.data.labels = yearMonths;
            couldSoldChart.data.datasets = [
                {
                label: "Moving average",
                backgroundColor: "black",
                data: movingAverageDataCould
            },
                {
                    label: "Disabled",
                    backgroundColor: "red",
                    data: disabledDataCould
                },
                {
                    label: "Rating only",
                    backgroundColor: "purple",
                    data: ratingDataCould
                },
                {
                    label: "Seasons only",
                    backgroundColor: "orange",
                    data: seasonsDataCould
                },
                {
                    label: "Rating & seasons",
                    backgroundColor: "blue",
                    data: ratingAndSeasonsDataCould
                }];
            couldSoldChart.update();
        }




        let movingAverageDataRedundant = moneyData.map(moneyDataPair => {
            var test = moneyDataPair ['Moving average']
            return  test.second
        });

        let disabledDataRedundant = moneyData.map(moneyDataPair => {
            var test = moneyDataPair ['Disabled']
            return  test.second
        });
        let ratingDataRedundant = moneyData.map(moneyDataPair => {
            var test = moneyDataPair ['RatingOnly']
            return  test.second
        });
        let seasonsDataRedundant = moneyData.map(moneyDataPair => {
            var test = moneyDataPair ['SeasonsOnly']
            return  test.second
        });
        let ratingAndSeasonsDataRedundant = moneyData.map(moneyDataPair => {
            var test = moneyDataPair ['Rating And Seasons']
            return  test.second
        });

        var redundantCtx = document.getElementById("redundantPurchaseChart").getContext('2d');
        var redundantData = {
            labels: yearMonths,
            datasets: [
                {
                    label: "Moving average",
                    backgroundColor: "black",
                    data: movingAverageDataRedundant
                },
                {
                    label: "Disabled",
                    backgroundColor: "red",
                    data: disabledDataRedundant
                },
                {
                    label: "Rating only",
                    backgroundColor: "purple",
                    data: ratingDataRedundant
                },
                {
                    label: "Seasons only",
                    backgroundColor: "orange",
                    data: seasonsDataRedundant
                },
                {
                    label: "Rating & seasons",
                    backgroundColor: "blue",
                    data: ratingAndSeasonsDataRedundant
                }
            ]
        };
        if (redundantPurchaseChart == null) {
            redundantPurchaseChart = new Chart(redundantCtx, {
                type: 'bar',
                data: redundantData,
                options: {
                    barValueSpacing: 20,
                    scales: {
                        yAxes: [{
                            ticks: {
                                min: 0,
                            }
                        }]
                    }
                }
            });
        }
        else {
            redundantPurchaseChart.data.labels = yearMonths;
            redundantPurchaseChart.data.datasets = [
                {
                    label: "Moving average",
                    backgroundColor: "black",
                    data: movingAverageDataRedundant
                },
                {
                    label: "Disabled",
                    backgroundColor: "red",
                    data: disabledDataRedundant
                },
                {
                    label: "Rating only",
                    backgroundColor: "purple",
                    data: ratingDataRedundant
                },
                {
                    label: "Seasons only",
                    backgroundColor: "orange",
                    data: seasonsDataRedundant
                },
                {
                    label: "Rating & seasons",
                    backgroundColor: "blue",
                    data: ratingAndSeasonsDataRedundant
                }];
            redundantPurchaseChart.update();
        }

    });
    /*]]>*/
</script>
<!--@formatter:on-->

</body>
</html>



